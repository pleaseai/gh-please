# GitHub CLI Field Definitions Maintenance

## Overview

This document explains how to maintain the GitHub CLI field definitions used for TOON and JSON format conversions in `gh-please`.

## Why Field Definitions Are Needed

GitHub CLI's **view commands** (e.g., `gh issue view`, `gh pr view`) require explicit field specification when using the `--json` flag:

```bash
# ❌ Fails - no fields specified
gh issue view 123 --json

# ✅ Works - fields explicitly listed
gh issue view 123 --json number,title,state,body,author,url
```

When users run `gh please issue view 123 --format toon`, we need to:
1. Detect the `--format toon` flag
2. Inject `--json <fields>` to get JSON output
3. Convert JSON to TOON format
4. Return to user

Without explicit field definitions, step 2 fails.

## Current Solution: Script-Generated Fields

We use a **script-based approach** to maintain field definitions:

1. **Script**: `scripts/update-gh-fields.ts` extracts available fields from `gh` CLI
2. **Generated File**: `src/lib/gh-fields.generated.ts` contains field mappings
3. **Update Process**: Run script manually when `gh` CLI updates
4. **Version Control**: Field changes tracked in git

## How to Update Field Definitions

### When to Update

Run the update script when:
- GitHub CLI version is updated (`gh version`)
- New commands are added to `gh` CLI
- Field definitions are missing for a command
- Weekly automated workflow detects changes (see `.github/workflows/update-gh-fields.yml`)

### Manual Update Process

```bash
# 1. Ensure gh CLI is up to date
gh version
gh upgrade

# 2. Run the update script
bun run update-fields

# 3. Review changes
git diff src/lib/gh-fields.generated.ts

# 4. Test the changes
bun test test/lib/gh-passthrough.test.ts

# 5. Commit if changes exist
git add src/lib/gh-fields.generated.ts
git commit -m "chore: update gh CLI field definitions"
```

### Automated Update Process

The repository includes a GitHub Actions workflow (`.github/workflows/update-gh-fields.yml`) that:
- Runs weekly (every Monday)
- Executes the update script
- Creates a PR if fields have changed
- Provides diff for review

**No manual intervention needed** - just review and merge the PR when created.

## Currently Supported Commands

The following commands have field definitions:

| Command | Fields Source | Updated |
|---------|---------------|---------|
| `issue view` | `gh issue view --json invalidfield` | Auto-detected |
| `pr view` | `gh pr view --json invalidfield` | Auto-detected |
| `repo view` | `gh repo view --json invalidfield` | Auto-detected |
| `release view` | `gh release view --json invalidfield` | Auto-detected |

## How Field Extraction Works

The update script uses a clever trick to extract available fields from `gh` CLI:

```bash
# Execute with invalid field name
gh issue view 123 --json invalidfield

# GitHub CLI responds with error listing all available fields:
# Unknown JSON field: "invalidfield"
# Available fields:
#   assignees
#   author
#   body
#   ...
```

The script:
1. Executes each command with `--json invalidfield`
2. Parses the stderr "Available fields:" section
3. Joins fields with commas
4. Generates TypeScript file with field mappings

## Generated File Structure

**File**: `src/lib/gh-fields.generated.ts`

```typescript
// Auto-generated by scripts/update-gh-fields.ts
// DO NOT EDIT MANUALLY - Run: bun run update-fields

/**
 * Last updated: 2025-01-31
 * gh version: 2.40.0
 */

export const GH_JSON_FIELDS: Record<string, string> = {
  'issue view': 'assignees,author,body,closed,closedAt,...',
  'pr view': 'assignees,author,body,commits,...',
  'repo view': 'name,owner,description,url,...',
  'release view': 'name,tagName,isLatest,createdAt,...',
}
```

## Integration with Passthrough

**File**: `src/lib/gh-passthrough.ts`

The passthrough logic uses field definitions when injecting `--json`:

```typescript
import { GH_JSON_FIELDS } from './gh-fields.generated'

function injectJsonFlag(args: string[]): string[] {
  const commandKey = args.slice(0, 2).join(' ') // e.g., "issue view"
  const fields = GH_JSON_FIELDS[commandKey]

  if (fields) {
    // Use generated fields for mapped commands
    return [...args, '--json', fields]
  }

  // Fallback for unmapped commands (list commands don't need fields)
  return [...args, '--json']
}
```

## Troubleshooting

### Script Fails to Extract Fields

**Symptom**: Script runs but doesn't detect fields

**Causes**:
- `gh` CLI not authenticated (`gh auth login`)
- Command requires argument (need valid issue/pr/repo number)
- GitHub API rate limit reached

**Solution**:
```bash
# Authenticate
gh auth login

# Check rate limit
gh api rate_limit

# Wait and retry
```

### Generated File Has No Changes

**Symptom**: Script runs successfully but no diff in git

**Cause**: GitHub CLI fields haven't changed since last update

**Action**: No action needed - this is normal

### Command Still Fails After Update

**Symptom**: `gh please issue view 123 --format toon` still fails

**Debugging**:
1. Check if command is in `GH_JSON_FIELDS` mapping
2. Verify field string format (comma-separated, no spaces)
3. Test with `gh` CLI directly: `gh issue view 123 --json <fields>`
4. Check for typos in field names

## Contributing

When adding support for new `gh` CLI commands:

1. Add command to `scripts/update-gh-fields.ts` command list
2. Run `bun run update-fields`
3. Test the generated fields
4. Update this documentation

## Related Documentation

- **ADR 0007**: gh CLI Passthrough (`docs-dev/adr/0007-gh-cli-passthrough.md`)
- **ADR 0006**: TOON Format Design (`docs-dev/adr/0006-toon-format.md`)
- **Passthrough Guide**: `docs-dev/GH_CLI_PASSTHROUGH.md`
- **GitHub ID Systems**: `docs-dev/GITHUB_ID_SYSTEMS.md`

## References

- [GitHub CLI Documentation](https://cli.github.com/manual/)
- [GitHub CLI JSON Output](https://cli.github.com/manual/gh_help_formatting)
